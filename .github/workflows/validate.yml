name: Validate

on:
  pull_request:
    branches:
      - master

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff format check
        run: ruff format --check custom_components/wattpilot/*.py
        continue-on-error: true

      - name: Run ruff lint
        run: ruff check custom_components/wattpilot/*.py --output-format=github
        continue-on-error: true

  validate-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if manifest.json changed
        id: manifest_changed
        run: |
          if git diff --name-only origin/master...HEAD | grep -q "custom_components/wattpilot/manifest.json"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate version format
        if: steps.manifest_changed.outputs.changed == 'true'
        run: |
          VERSION=$(jq -r '.version' custom_components/wattpilot/manifest.json)
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid version format: $VERSION"
            echo "Version must be in format X.Y.Z (e.g., 0.3.8)"
            exit 1
          fi
          echo "✅ Valid version format: $VERSION"

      - name: Check changelog updated
        if: steps.manifest_changed.outputs.changed == 'true'
        run: |
          VERSION=$(jq -r '.version' custom_components/wattpilot/manifest.json)
          if ! grep -q "\[$VERSION\]" CHANGELOG.md; then
            echo "❌ CHANGELOG.md does not contain an entry for version $VERSION"
            echo "Please update CHANGELOG.md with release notes for this version"
            exit 1
          fi
          echo "✅ CHANGELOG.md contains entry for version $VERSION"

  hacs-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: HACS Validation
        uses: hacs/action@main
        with:
          category: integration
